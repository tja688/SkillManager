<Page x:Class="SkillManager.Views.LibraryPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:viewmodels="clr-namespace:SkillManager.ViewModels"
      xmlns:models="clr-namespace:SkillManager.Models"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="900"
      Foreground="{DynamicResource TextFillColorPrimaryBrush}"
      Title="LibraryPage"
      d:DataContext="{d:DesignInstance viewmodels:LibraryViewModel}">

    <!-- 
    关键修复：不使用 ScrollViewer，让 NavigationView 自带的 ScrollViewer 处理滚动
    问题原因：NavigationView 内部有 ScrollViewer，给内容提供无限高度
    解决方案：移除我们自己的 ScrollViewer，直接使用 ItemsControl，让外层 ScrollViewer 处理滚动
    -->
    
    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header Toolbar -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel>
                <TextBlock Text="技能库" FontSize="28" FontWeight="SemiBold"/>
                <TextBlock Text="{Binding SelectedGroup.Name, StringFormat=当前分组：{0}}"
                           Margin="0,4,0,0"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
                <ui:Button Width="32"
                           Height="32"
                           Padding="0"
                           Margin="0,0,8,0"
                           Appearance="Transparent"
                           Icon="{ui:SymbolIcon MoreHorizontal24}"
                           ToolTip="翻译工具"
                           Click="TranslationMenuButton_Click">
                    <ui:Button.ContextMenu>
                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                            <MenuItem Header="启用翻译服务"
                                      IsCheckable="True"
                                      IsChecked="{Binding IsTranslationEnabled, Mode=TwoWay}" />
                            <Separator />
                            <MenuItem Header="批量预翻译"
                                      Command="{Binding StartPretranslateCommand}"
                                      IsEnabled="{Binding IsTranslationEnabled}" />
                            <MenuItem Header="取消翻译"
                                      Command="{Binding CancelPretranslateCommand}"
                                      IsEnabled="{Binding IsBatchTranslationRunning}" />
                            <MenuItem Header="清空翻译缓存"
                                      Command="{Binding ClearTranslationCacheCommand}" />
                        </ContextMenu>
                    </ui:Button.ContextMenu>
                </ui:Button>
                <ui:TextBox PlaceholderText="搜索技能..." 
                            Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                            Icon="{ui:SymbolIcon Search24}"
                            Width="240"
                            Margin="0,0,10,0"/>
                
                <ui:Button Command="{Binding ManageGroupsCommand}" 
                           Icon="{ui:SymbolIcon AppsListDetail24}"
                           Content="管理分组"
                           Margin="0,0,10,0"/>

                <ui:Button Command="{Binding AddSelectedToGroupsCommand}"
                           Icon="{ui:SymbolIcon Tag24}"
                           Content="添加到分组"
                           IsEnabled="{Binding HasSelection}"
                           Margin="0,0,10,0"/>

                <ui:Button Command="{Binding SelectAllFilteredCommand}"
                           Icon="{ui:SymbolIcon Checkmark24}"
                           Content="全选"
                           IsEnabled="{Binding FilteredSkills.Count, Converter={StaticResource CountToBoolConverter}}"
                           Margin="0,0,10,0"/>
                
                <ui:Button Command="{Binding RefreshSkillsCommand}" 
                           Icon="{ui:SymbolIcon ArrowClockwise24}"
                           Content="刷新"/>
            </StackPanel>
        </Grid>

        <!-- Translation Status -->
        <Grid Grid.Row="1" Margin="0,8,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <ui:ProgressRing Width="16"
                                 Height="16"
                                 IsIndeterminate="True"
                                 Visibility="{Binding IsTranslationRunning, Converter={StaticResource BoolToVisibilityConverter}}" />
                <TextBlock Margin="8,0,0,0"
                           FontSize="12"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           Text="{Binding TranslationStatusMessage}"
                           Visibility="{Binding TranslationStatusMessage, Converter={StaticResource StringToVisibilityConverter}}" />
            </StackPanel>

        </Grid>

        <!-- Skill List - 直接使用 ItemsControl，不包装 ScrollViewer -->
        <Grid Grid.Row="2" Margin="0,16,0,0">
            <ui:ProgressRing IsIndeterminate="True"
                             Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Center"
                             Width="50"
                             Height="50"
                             Panel.ZIndex="10" />

            <ItemsControl x:Name="SkillsItemsControl"
                          ItemsSource="{Binding FilteredSkills}"
                          Margin="0,0,0,0"
                          Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Invert}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <!-- 使用 UniformGrid 实现均匀分布布局 -->
                        <UniformGrid Columns="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource WidthToColumnsConverter}, ConverterParameter=280}" 
                                     Rows="0"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Margin" Value="8" />
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:SkillFolder}">
                        <ui:Card Padding="16"
                                 Cursor="Hand"
                                 MinHeight="200"
                                 ToolTip="{Binding WhenToUseDisplay}"
                                 MouseLeftButtonUp="SkillCard_MouseLeftButtonUp">
                            <ui:Card.Style>
                                <Style TargetType="ui:Card" BasedOn="{StaticResource {x:Type ui:Card}}">
                                    <Setter Property="BorderThickness" Value="1" />
                                    <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}" />
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundFillColorDefaultBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                            <Setter Property="BorderBrush" Value="{DynamicResource AccentFillColorDefaultBrush}" />
                                            <Setter Property="BorderThickness" Value="2" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Card.Style>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <TextBlock FontSize="16"
                                               FontWeight="SemiBold"
                                               Text="{Binding Name}"
                                               TextTrimming="CharacterEllipsis" />

                                    <ui:Button Grid.Column="1"
                                               Width="18"
                                               Height="18"
                                               Padding="0"
                                               Margin="0"
                                               Appearance="Transparent"
                                               HorizontalAlignment="Right"
                                               VerticalAlignment="Top"
                                               Command="{Binding DataContext.EnterMultiSelectModeCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="进入多选">
                                        <Grid Width="14" Height="14">
                                            <Ellipse Stroke="{DynamicResource TextFillColorTertiaryBrush}" StrokeThickness="1" Fill="Transparent" />
                                            <Ellipse Margin="3"
                                                     Fill="{DynamicResource TextFillColorSecondaryBrush}"
                                                     Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibilityConverter}}" />
                                        </Grid>
                                    </ui:Button>
                                </Grid>

                                <TextBlock Grid.Row="1"
                                           Margin="0,6,0,0"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Text="{Binding SkillTitle}"
                                           TextTrimming="CharacterEllipsis"
                                           Visibility="{Binding SkillTitle, Converter={StaticResource StringToVisibilityConverter}}" />

                                <TextBlock Grid.Row="2"
                                           Margin="0,6,0,0"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Text="{Binding WhenToUseDisplay}"
                                           TextTrimming="CharacterEllipsis"
                                           TextWrapping="Wrap"
                                           MaxHeight="48"
                                           Visibility="{Binding WhenToUseDisplay, Converter={StaticResource StringToVisibilityConverter}}" />

                                <TextBlock Grid.Row="3"
                                           Margin="0,6,0,0"
                                           FontSize="11"
                                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                           Text="{Binding TranslationStatusMessage}"
                                           TextTrimming="CharacterEllipsis"
                                           Visibility="{Binding TranslationStatusMessage, Converter={StaticResource StringToVisibilityConverter}}" />

                                <TextBlock Grid.Row="4"
                                           Margin="0,8,0,0"
                                           FontSize="12"
                                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                           Text="{Binding GroupNamesDisplay, StringFormat=所属分组：{0}}"
                                           TextTrimming="CharacterEllipsis" />

                                <StackPanel Grid.Row="5"
                                            Margin="0,12,0,0"
                                            HorizontalAlignment="Right"
                                            Orientation="Horizontal">
                                    <ui:Button Margin="0,0,4,0"
                                               Padding="8,4"
                                               Icon="{ui:SymbolIcon FolderOpen24}"
                                               Command="{Binding DataContext.OpenSkillFolderCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="打开文件夹" />

                                    <ui:Button Margin="0,0,4,0"
                                               Padding="8,4"
                                               Icon="{ui:SymbolIcon Tag24}"
                                               Command="{Binding DataContext.ManageSkillGroupsCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="管理分组" />

                                    <ui:Button Padding="8,4"
                                               Icon="{ui:SymbolIcon Delete24}"
                                               Command="{Binding DataContext.DeleteSkillCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="删除技能"
                                               Appearance="Danger" />
                                </StackPanel>
                            </Grid>
                        </ui:Card>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </Grid>
</Page>
